FROM bgrins/vwa-shopping-optimized-base:latest AS extractor
# Extract only the web application files from the bloated image
COPY --from=shopping_final_0712 /var/www/magento2 /var/www/magento2

FROM bgrins/vwa-shopping-optimized-base:latest

RUN mkdir -p /var/www/magento2 && \
    chown -R www-data:www-data /var/www/magento2

WORKDIR /var/www/magento2

# Copy only the application files
COPY --from=extractor /var/www/magento2 /var/www/magento2

# Copy nginx configuration
COPY nginx-default.conf /etc/nginx/conf.d/default.conf

# Copy web-only entrypoint
COPY entrypoint-web.sh /docker-entrypoint-web.sh
RUN chmod +x /docker-entrypoint-web.sh

# Environment variables for external MySQL connection
ENV MYSQL_HOST=mysql \
    MYSQL_PORT=3306 \
    MYSQL_DATABASE=magentodb \
    MYSQL_USER=magentouser \
    MYSQL_PASSWORD=MyPassword \
    BASE_URL=http://localhost:7770

# Expose only web-related ports (no MySQL port)
EXPOSE 80 9200 6379 88 25

ENTRYPOINT ["/docker-entrypoint-web.sh"]
CMD ["supervisord", "-n", "-j", "/supervisord.pid"]